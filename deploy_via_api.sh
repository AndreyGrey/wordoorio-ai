#!/bin/bash
echo "üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Yandex Cloud API"

# –ù–æ–≤—ã–π —Ç–æ–∫–µ–Ω –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
NEW_TOKEN="t1.9euelZqSz8eTk8zKns6cnczOypTHj-3rnpWamJWVzJCejc2Wx8zPm8-PnJTl9PdaU2k2-e8YPiOX3fT3GgJnNvnvGD4jl83n9euelZrGyZmJnpyMzIydmovKip6bi-_8xeuelZrGyZmJnpyMzIydmovKip6biw.e2sWVjx3Rw3aBUxqwPZIJCZCb2J-WSICKO0IJMyHigYOiy1yXJpZup4rlWp0kSSPR9eso0SPn_pAWN2LSN-dAA"

echo "üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞:"
echo "1. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞"
echo "2. üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä (–º–æ–∂–µ—Ç –ø–æ–º–æ—á—å –æ–±–Ω–æ–≤–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ)"  
echo "3. üì¶ –°–æ–∑–¥–∞—Ç—å —Å–Ω–∏–º–æ–∫ –∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏"
echo "4. üÜï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é VM —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π"

echo ""
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞..."

# –ü—Ä–æ–≤–µ—Ä–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞
~/yandex-cloud/bin/yc compute instance get wordoorio-vm --format json > /tmp/vm_state.json

echo "üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ä–≤–µ—Ä–µ:"
echo "–°—Ç–∞—Ç—É—Å: $(cat /tmp/vm_state.json | grep '"status"' | cut -d'"' -f4)"
echo "IP: $(cat /tmp/vm_state.json | grep '"address"' | head -1 | cut -d'"' -f4)"
echo "–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ SSH: $(cat /tmp/vm_state.json | grep 'ssh_authorization' | cut -d'"' -f4)"

echo ""
echo "üåê –¢–µ—Å—Ç–∏—Ä—É–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –≤–µ–±-—Å–µ—Ä–≤–∏—Å–∞..."
HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://wordoorio.ru)
echo "HTTP —Å—Ç–∞—Ç—É—Å: $HTTP_STATUS"

if [ "$HTTP_STATUS" = "200" ]; then
    echo "‚úÖ –í–µ–±-—Å–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—á–∞–µ—Ç"
    
    echo "üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º API —Å –ø—Ä–æ—Å—Ç—ã–º –∑–∞–ø—Ä–æ—Å–æ–º..."
    API_TEST=$(curl -s -X POST https://wordoorio.ru/analyze \
        -H "Content-Type: application/json" \
        -d '{"text": "Machine learning algorithms analyze complex patterns in datasets using sophisticated methods"}' | \
        grep -o '"error"' | head -1)
    
    if [ "$API_TEST" = '"error"' ]; then
        echo "‚ùå API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫–∏ (–≤–µ—Ä–æ—è—Ç–Ω–æ, –ø—Ä–æ–±–ª–µ–º–∞ —Å —Ç–æ–∫–µ–Ω–∞–º–∏)"
        echo "üîß –¢—Ä–µ–±—É–µ—Ç—Å—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"
    else
        echo "‚úÖ API —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
    fi
else
    echo "‚ùå –í–µ–±-—Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
fi

echo ""
echo "üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:"
echo "1. –ï—Å–ª–∏ API —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –µ—Å—Ç—å –æ—à–∏–±–∫–∏ —Ç–æ–∫–µ–Ω–æ–≤ - –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å .env –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"
echo "2. –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω - –Ω—É–∂–µ–Ω –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∏–ª–∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ VM"
echo "3. –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è –ø–æ–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ"

echo ""
echo "üîß –î–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è —Ç—Ä–µ–±—É–µ—Ç—Å—è –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤:"
echo "a) SSH –¥–æ—Å—Ç—É–ø –¥–ª—è –ø—Ä—è–º–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤"
echo "b) –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ VM —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π"  
echo "c) –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ cloud-init –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π"

rm -f /tmp/vm_state.json