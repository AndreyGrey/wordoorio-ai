name: Deploy to Yandex Cloud Serverless Container

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  REGISTRY_ID: crp1mj4p9ro0clhe5t61
  IMAGE_NAME: wordoorio-ai
  CONTAINER_NAME: wordoorio
  SERVICE_ACCOUNT_ID: aje3bsioau9v6s0n5b6s

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Yandex Cloud CLI
      run: |
        curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
        echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH

    - name: Authenticate with Yandex Cloud
      run: |
        echo '${{ secrets.YANDEX_CLOUD_KEY }}' | base64 -d > key.json
        yc config set service-account-key key.json
        yc config set cloud-id ${{ secrets.YANDEX_CLOUD_ID }}
        yc config set folder-id ${{ secrets.YANDEX_FOLDER_ID }}

    - name: Configure Docker for Yandex Container Registry
      run: |
        yc container registry configure-docker

    - name: Build Docker image
      run: |
        docker build -t cr.yandex/${{ env.REGISTRY_ID }}/${{ env.IMAGE_NAME }}:latest .
        docker tag cr.yandex/${{ env.REGISTRY_ID }}/${{ env.IMAGE_NAME }}:latest \
                   cr.yandex/${{ env.REGISTRY_ID }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

    - name: Push Docker image to Container Registry
      run: |
        docker push cr.yandex/${{ env.REGISTRY_ID }}/${{ env.IMAGE_NAME }}:latest
        docker push cr.yandex/${{ env.REGISTRY_ID }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

    - name: Update Serverless Container
      run: |
        # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –Ω–æ–≤—ã–º –æ–±—Ä–∞–∑–æ–º
        # IAM —Ç–æ–∫–µ–Ω –ø–æ–ª—É—á–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ Metadata Service
        yc serverless container revision deploy \
          --container-name ${{ env.CONTAINER_NAME }} \
          --image cr.yandex/${{ env.REGISTRY_ID }}/${{ env.IMAGE_NAME }}:latest \
          --cores 1 \
          --memory 1GB \
          --execution-timeout 180s \
          --service-account-id ${{ env.SERVICE_ACCOUNT_ID }} \
          --environment YANDEX_FOLDER_ID=${{ secrets.YANDEX_FOLDER_ID }},TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }},YANDEX_DICT_API_KEY=${{ secrets.YANDEX_DICT_API_KEY }}

    - name: Get Container URL
      run: |
        CONTAINER_ID=$(yc serverless container get ${{ env.CONTAINER_NAME }} --format json | jq -r '.id')
        echo "üöÄ Container deployed successfully!"
        echo "üì± Container ID: $CONTAINER_ID"