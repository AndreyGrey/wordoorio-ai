name: Deploy Wordoorio to Yandex Cloud

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Yandex Cloud CLI
      run: |
        curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
        echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH
        
    - name: Authenticate with Yandex Cloud
      run: |
        echo '${{ secrets.YANDEX_CLOUD_KEY }}' | base64 -d > key.json
        yc config set service-account-key key.json
        yc config set cloud-id ${{ secrets.YANDEX_CLOUD_ID }}
        yc config set folder-id ${{ secrets.YANDEX_FOLDER_ID }}
        
    - name: Create deployment package
      run: |
        cd mini-deploy
        zip -r ../wordoorio-deploy.zip . -x "*.pyc" "__pycache__/*"
        cd ..
        
    - name: Deploy to Cloud Function
      run: |
        yc serverless function version create \
          --function-name wordoorio-function \
          --runtime python39 \
          --entrypoint index.handler \
          --memory 256m \
          --execution-timeout 60s \
          --source-path wordoorio-deploy.zip \
          --environment YANDEX_FOLDER_ID=${{ secrets.YANDEX_FOLDER_ID }}
          
    - name: Get function URL
      run: |
        FUNCTION_ID=$(yc serverless function get wordoorio-function --format json | jq -r '.id')
        echo "ðŸš€ Function deployed successfully!"
        echo "ðŸ“± URL: https://functions.yandexcloud.net/$FUNCTION_ID"