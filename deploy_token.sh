#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

SERVER="yc-user@158.160.126.200"
ENV_FILE="/var/www/wordoorio/.env"

echo "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."

# –ü–æ–ª—É—á–∞–µ–º –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ
echo "üîß –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω..."
NEW_TOKEN=$(~/yandex-cloud/bin/yc iam create-token)

if [ $? -ne 0 ]; then
    echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω"
    exit 1
fi

if [ -z "$NEW_TOKEN" ]; then
    echo "‚ùå –¢–æ–∫–µ–Ω –ø—É—Å—Ç–æ–π"
    exit 1
fi

echo "‚úÖ –ü–æ–ª—É—á–µ–Ω –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω: ${NEW_TOKEN:0:20}..."

# –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–∫–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
echo "üì§ –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–∫–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
ssh $SERVER "sudo sed -i 's/^YANDEX_IAM_TOKEN=.*/YANDEX_IAM_TOKEN=$NEW_TOKEN/' $ENV_FILE"

if [ $? -ne 0 ]; then
    echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å .env —Ñ–∞–π–ª"
    exit 1
fi

echo "‚úÖ –¢–æ–∫–µ–Ω –æ–±–Ω–æ–≤–ª–µ–Ω –≤ .env —Ñ–∞–π–ª–µ"

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å
echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å..."
ssh $SERVER "sudo systemctl restart wordoorio"

if [ $? -eq 0 ]; then
    echo "‚úÖ –°–µ—Ä–≤–∏—Å wordoorio –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω"
    echo "üéâ –¢–æ–∫–µ–Ω —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!"
else
    echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–µ—Ä–≤–∏—Å, –Ω–æ —Ç–æ–∫–µ–Ω –æ–±–Ω–æ–≤–ª–µ–Ω"
fi