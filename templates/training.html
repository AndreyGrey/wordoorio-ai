<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ | Wordoorio</title>

    <!-- CSS —Å–∏—Å—Ç–µ–º–∞ -->
    <link rel="stylesheet" href="/static/css/variables.css">
    <link rel="stylesheet" href="/static/css/global.css">
    <link rel="stylesheet" href="/static/css/components.css">

    <!-- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã -->
    <script src="/static/js/Auth.js"></script>
    <script src="/static/components/Header.js"></script>

    <style>
        /* –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ */
        .training-header {
            text-align: center;
            color: var(--color-text-white);
            margin-bottom: var(--spacing-8);
        }

        .training-card {
            max-width: 600px;
            margin: 0 auto;
        }

        .word-display {
            text-align: center;
            padding: var(--spacing-8) 0;
            border-bottom: 2px solid var(--color-border-light);
            margin-bottom: var(--spacing-6);
        }

        .word-en {
            font-size: var(--font-size-3xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-primary);
            margin-bottom: var(--spacing-2);
        }

        .word-type {
            font-size: var(--font-size-sm);
            color: var(--color-text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .progress-bar {
            background: var(--color-bg-light);
            height: 8px;
            border-radius: var(--radius-pill);
            overflow: hidden;
            margin-bottom: var(--spacing-4);
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-primary);
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            color: var(--color-text-white);
            font-size: var(--font-size-sm);
            margin-bottom: var(--spacing-6);
            font-weight: var(--font-weight-medium);
        }

        .options-container {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-3);
        }

        .option-btn {
            padding: var(--spacing-5);
            border: 2px solid var(--color-border-light);
            border-radius: var(--radius-md);
            background: var(--color-bg-white);
            cursor: pointer;
            transition: var(--transition-base);
            font-size: var(--font-size-base);
            text-align: left;
            color: var(--color-text-primary);
            font-weight: var(--font-weight-medium);
        }

        .option-btn:hover {
            border-color: var(--color-primary);
            background: var(--color-bg-light);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .option-btn.correct {
            border-color: var(--color-primary);
            background: var(--color-success);
            color: var(--color-success-text);
        }

        .option-btn.incorrect {
            border-color: #e53e3e;
            background: var(--color-error);
            color: var(--color-error-text);
        }

        .option-btn:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        .result-feedback {
            text-align: center;
            padding: var(--spacing-6);
            border-radius: var(--radius-md);
            margin-top: var(--spacing-6);
            font-weight: var(--font-weight-semibold);
        }

        .result-feedback.correct {
            background: var(--color-success);
            color: var(--color-success-text);
        }

        .result-feedback.incorrect {
            background: var(--color-error);
            color: var(--color-error-text);
        }

        .word-stats {
            display: flex;
            justify-content: space-around;
            margin-top: var(--spacing-4);
            padding-top: var(--spacing-4);
            border-top: 2px solid var(--color-border-light);
        }

        .stat {
            text-align: center;
        }

        .stat-label {
            font-size: var(--font-size-sm);
            color: var(--color-text-muted);
            display: block;
        }

        .stat-value {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-primary);
            display: block;
            margin-top: var(--spacing-1);
        }

        .completion-screen {
            text-align: center;
            padding: var(--spacing-12) var(--spacing-6);
        }

        .completion-icon {
            font-size: 4rem;
            margin-bottom: var(--spacing-6);
        }

        .completion-title {
            font-size: var(--font-size-2xl);
            color: var(--color-text-primary);
            margin-bottom: var(--spacing-4);
        }

        .completion-stats {
            background: var(--color-bg-light);
            padding: var(--spacing-6);
            border-radius: var(--radius-md);
            margin: var(--spacing-6) 0;
        }

        .empty-state {
            text-align: center;
            padding: var(--spacing-16) var(--spacing-6);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: var(--spacing-6);
        }

        @media (max-width: 768px) {
            .word-en {
                font-size: var(--font-size-2xl);
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div id="header-container"></div>

    <div class="container">
        <div class="training-header">
            <h1>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å–ª–æ–≤</h1>
            <p>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–≤–æ–∏ –∑–Ω–∞–Ω–∏—è –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö —Å–ª–æ–≤</p>
        </div>

        <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å -->
        <div id="progress-container" style="display: none;">
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
            </div>
            <div id="progress-text" class="progress-text">–¢–µ—Å—Ç 0 –∏–∑ 0</div>
        </div>

        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ -->
        <div id="training-card" class="card card-lg training-card" style="display: none;">
            <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ª–æ–≤–∞ -->
            <div class="word-display">
                <div id="word-english" class="word-en">...</div>
                <div id="word-type" class="word-type"></div>
            </div>

            <!-- –í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤ -->
            <div id="options-container" class="options-container">
                <!-- –í–∞—Ä–∏–∞–Ω—Ç—ã –¥–æ–±–∞–≤—è—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
            </div>

            <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–≤–µ—Ç–∞ -->
            <div id="result-feedback" class="result-feedback" style="display: none;">
                <div id="feedback-text"></div>
                <div class="word-stats">
                    <div class="stat">
                        <span class="stat-label">–†–µ–π—Ç–∏–Ω–≥</span>
                        <span id="stat-rating" class="stat-value">-</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">–°—Ç–∞—Ç—É—Å</span>
                        <span id="stat-status" class="stat-value">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è -->
        <div id="completion-screen" class="card card-lg training-card completion-screen" style="display: none;">
            <div class="completion-icon">‚úì</div>
            <h2 class="completion-title">–û—Ç–ª–∏—á–Ω–æ! –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã!</h2>
            <div class="completion-stats">
                <p>–í—ã –∑–∞–≤–µ—Ä—à–∏–ª–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É!</p>
            </div>
            <button id="restart-btn" class="btn btn-primary btn-lg">–ù–∞—á–∞—Ç—å –µ—â—ë 8 —Å–ª–æ–≤</button>
        </div>

        <!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ / –ó–∞–≥—Ä—É–∑–∫–∞ -->
        <div id="empty-state" class="card card-lg training-card empty-state">
            <div class="empty-state-icon">?</div>
            <h2>–ì–æ—Ç–æ–≤—ã –∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ?</h2>
            <p style="color: var(--color-text-muted); margin: var(--spacing-6) 0;">
                –ú—ã –≤—ã–±–µ—Ä–µ–º 8 —Å–ª–æ–≤ –∏–∑ –≤–∞—à–µ–≥–æ —Å–ª–æ–≤–∞—Ä—è –¥–ª—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
            </p>
            <button id="start-btn" class="btn btn-primary btn-lg">–ù–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</button>
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ö—ç–¥–µ—Ä–∞
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof initUnifiedHeader === 'function') {
                initUnifiedHeader('header-container');
            }
        });

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
        let currentTraining = null;
        let currentTestIndex = 0;

        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const startBtn = document.getElementById('start-btn');
        const restartBtn = document.getElementById('restart-btn');
        const emptyState = document.getElementById('empty-state');
        const trainingCard = document.getElementById('training-card');
        const completionScreen = document.getElementById('completion-screen');
        const progressContainer = document.getElementById('progress-container');
        const progressFill = document.getElementById('progress-fill');
        const progressText = document.getElementById('progress-text');
        const wordEnglish = document.getElementById('word-english');
        const wordType = document.getElementById('word-type');
        const optionsContainer = document.getElementById('options-container');
        const resultFeedback = document.getElementById('result-feedback');
        const feedbackText = document.getElementById('feedback-text');
        const statRating = document.getElementById('stat-rating');
        const statStatus = document.getElementById('stat-status');

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', async () => {
            const user = await checkAuth();
            if (!user) {
                emptyState.innerHTML = `
                    <div class="empty-state-icon">!</div>
                    <h2>–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
                    <p style="color: var(--color-text-muted); margin: var(--spacing-6) 0;">
                        –í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Telegram, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É
                    </p>
                    <a href="/" class="btn btn-primary">–ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
                `;
                return;
            }
        });

        // –ù–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É
        startBtn.addEventListener('click', startTraining);
        restartBtn.addEventListener('click', startTraining);

        async function startTraining() {
            try {
                startBtn.disabled = true;
                startBtn.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';

                const response = await fetch('/api/training/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin'
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || '–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏');
                }

                currentTraining = data;
                currentTestIndex = 0;

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
                emptyState.style.display = 'none';
                completionScreen.style.display = 'none';
                trainingCard.style.display = 'block';
                progressContainer.style.display = 'block';

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–π —Ç–µ—Å—Ç
                showTest();

            } catch (error) {
                alert(error.message);
                startBtn.disabled = false;
                startBtn.textContent = '–ù–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É üöÄ';
            }
        }

        function showTest() {
            if (!currentTraining || currentTestIndex >= currentTraining.tests.length) {
                showCompletion();
                return;
            }

            const test = currentTraining.tests[currentTestIndex];

            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
            const progress = ((currentTestIndex + 1) / currentTraining.tests.length) * 100;
            progressFill.style.width = `${progress}%`;
            progressText.textContent = `–¢–µ—Å—Ç ${currentTestIndex + 1} –∏–∑ ${currentTraining.tests.length}`;

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ª–æ–≤–æ
            wordEnglish.textContent = test.word;
            wordType.textContent = test.type || '';

            // –°–∫—Ä—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Ç–µ—Å—Ç–∞
            resultFeedback.style.display = 'none';

            // –°–æ–∑–¥–∞–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤
            optionsContainer.innerHTML = '';
            test.options.forEach((option, index) => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.textContent = option.text;
                btn.onclick = () => submitAnswer(test.test_id, option.text, btn);
                optionsContainer.appendChild(btn);
            });
        }

        async function submitAnswer(testId, selectedOption, buttonElement) {
            try {
                // –ë–ª–æ–∫–∏—Ä—É–µ–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏
                const allButtons = optionsContainer.querySelectorAll('.option-btn');
                allButtons.forEach(btn => btn.disabled = true);

                const response = await fetch('/api/training/answer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        test_id: testId,
                        answer: selectedOption
                    })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞');
                }

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                if (result.is_correct) {
                    buttonElement.classList.add('correct');
                    resultFeedback.className = 'result-feedback correct';
                    feedbackText.textContent = '–ü—Ä–∞–≤–∏–ª—å–Ω–æ!';
                } else {
                    buttonElement.classList.add('incorrect');
                    resultFeedback.className = 'result-feedback incorrect';
                    feedbackText.innerHTML = `–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ<br><small>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: ${result.correct_translation}</small>`;
                }

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                statRating.textContent = `${result.new_rating}/10`;
                statStatus.textContent = result.new_status;
                resultFeedback.style.display = 'block';

                // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Ç–µ—Å—Ç—É —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    currentTestIndex++;
                    showTest();
                }, 2000);

            } catch (error) {
                alert(error.message);
                // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                const allButtons = optionsContainer.querySelectorAll('.option-btn');
                allButtons.forEach(btn => btn.disabled = false);
            }
        }

        function showCompletion() {
            trainingCard.style.display = 'none';
            progressContainer.style.display = 'none';
            completionScreen.style.display = 'block';
        }
    </script>
</body>
</html>
