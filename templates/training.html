<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Тренировка | Wordoorio</title>

    <!-- CSS система -->
    <link rel="stylesheet" href="/static/css/variables.css">
    <link rel="stylesheet" href="/static/css/global.css">
    <link rel="stylesheet" href="/static/css/components.css">

    <!-- Компоненты -->
    <script src="/static/js/Auth.js"></script>
    <script src="/static/components/Header.js"></script>

    <style>
        /* Специфичные стили для тренировки */
        .training-header {
            text-align: center;
            color: var(--color-text-white);
            margin-bottom: var(--spacing-8);
        }

        .training-card {
            max-width: 600px;
            margin: 0 auto;
            animation: slideInRight 0.4s ease-out;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .word-display {
            text-align: center;
            padding: var(--spacing-10) var(--spacing-6);
            background: linear-gradient(135deg, #f7fafc 0%, #ffffff 100%);
            border-radius: var(--radius-lg);
            margin-bottom: var(--spacing-6);
            position: relative;
        }

        .word-display::before {
            content: '';
            display: none;
        }

        .word-en {
            font-size: var(--font-size-3xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-primary);
            margin-bottom: var(--spacing-3);
            animation: popIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes popIn {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }


        .progress-bar {
            background: var(--color-bg-light);
            height: 10px;
            border-radius: var(--radius-pill);
            overflow: hidden;
            margin-bottom: var(--spacing-4);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-primary);
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                90deg,
                rgba(255, 255, 255, 0) 0%,
                rgba(255, 255, 255, 0.3) 50%,
                rgba(255, 255, 255, 0) 100%
            );
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .progress-text {
            text-align: center;
            color: var(--color-text-white);
            font-size: var(--font-size-sm);
            margin-bottom: var(--spacing-6);
            font-weight: var(--font-weight-semibold);
            letter-spacing: 0.5px;
        }

        .options-container {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-3);
        }

        .option-btn {
            padding: var(--spacing-5) var(--spacing-6);
            border: 2px solid var(--color-border-light);
            border-radius: var(--radius-lg);
            background: var(--color-bg-white);
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: var(--font-size-md);
            text-align: left;
            color: var(--color-text-primary);
            font-weight: var(--font-weight-medium);
            position: relative;
            opacity: 0;
            animation: fadeInOption 0.4s ease-out forwards;
        }

        @keyframes fadeInOption {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .option-btn:nth-child(1) { animation-delay: 0.1s; }
        .option-btn:nth-child(2) { animation-delay: 0.2s; }
        .option-btn:nth-child(3) { animation-delay: 0.3s; }
        .option-btn:nth-child(4) { animation-delay: 0.4s; }

        .option-btn:hover:not(:disabled) {
            border-color: var(--color-primary);
            background: var(--color-bg-light);
            transform: translateX(4px) scale(1.02);
            box-shadow: var(--shadow-md);
        }

        .option-btn:active:not(:disabled) {
            transform: scale(0.98);
        }

        .option-btn.correct {
            border-color: var(--color-primary);
            border-width: 3px;
            background: var(--color-success);
            color: var(--color-success-text);
            animation: successPulse 0.6s ease;
            font-weight: var(--font-weight-semibold);
        }

        @keyframes successPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .option-btn.incorrect {
            border-color: #e53e3e;
            border-width: 3px;
            background: var(--color-error);
            color: var(--color-error-text);
            animation: shake 0.5s ease;
            font-weight: var(--font-weight-semibold);
        }

        .option-btn.faded {
            opacity: 0.3;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .answer-explanation {
            margin-top: var(--spacing-2);
            padding-top: var(--spacing-2);
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-normal);
            opacity: 0.9;
        }

        .option-btn:disabled {
            cursor: not-allowed;
        }

        .option-btn:disabled:not(.correct):not(.incorrect) {
            opacity: 0.6;
        }


        .completion-screen {
            text-align: center;
            padding: var(--spacing-8) var(--spacing-6);
            animation: fadeInUp 0.6s ease-out;
        }

        .completion-title {
            font-size: var(--font-size-xl);
            color: var(--color-text-primary);
            font-weight: var(--font-weight-semibold);
            margin-bottom: var(--spacing-6);
        }

        .completion-stats {
            margin: var(--spacing-6) 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-4);
        }

        .stat-box {
            padding: var(--spacing-4);
            background: var(--color-bg-light);
            border-radius: var(--radius-md);
        }

        .stat-box-value {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-primary);
            display: block;
            margin-bottom: var(--spacing-1);
        }

        .stat-box-label {
            font-size: var(--font-size-sm);
            color: var(--color-text-muted);
        }

        .empty-state {
            text-align: center;
            padding: var(--spacing-12) var(--spacing-6);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 300px;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Состояние загрузки */
        .loading-state {
            text-align: center;
            padding: var(--spacing-12) var(--spacing-6);
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            margin: 0 auto var(--spacing-6);
            border: 4px solid var(--color-bg-light);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-title {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            margin-bottom: var(--spacing-3);
        }

        .loading-subtitle {
            font-size: var(--font-size-base);
            color: var(--color-text-muted);
            margin-bottom: var(--spacing-6);
        }

        .loading-tips {
            margin-top: var(--spacing-6);
            height: 60px;
            overflow: hidden;
            position: relative;
        }

        .loading-tip {
            font-size: var(--font-size-sm);
            color: var(--color-text-muted);
            line-height: var(--line-height-relaxed);
            font-style: italic;
            text-align: center;
            padding: var(--spacing-2) var(--spacing-4);
            opacity: 0;
            position: absolute;
            width: 100%;
            animation: rotateTip 12s infinite;
        }

        .loading-tip:nth-child(1) { animation-delay: 0s; }
        .loading-tip:nth-child(2) { animation-delay: 4s; }
        .loading-tip:nth-child(3) { animation-delay: 8s; }

        @keyframes rotateTip {
            0%, 33.33% { opacity: 0; transform: translateY(20px); }
            36.33%, 63.33% { opacity: 1; transform: translateY(0); }
            66.33%, 100% { opacity: 0; transform: translateY(-20px); }
        }

        @media (max-width: 768px) {
            .training-header h1 {
                font-size: var(--font-size-xl);
            }

            .training-header p {
                font-size: var(--font-size-sm);
            }

            .training-card {
                padding: var(--spacing-5);
            }

            .word-display {
                padding: var(--spacing-6) var(--spacing-4);
            }

            .word-en {
                font-size: var(--font-size-2xl);
            }

            .option-btn {
                padding: var(--spacing-4) var(--spacing-5);
                font-size: var(--font-size-base);
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: var(--spacing-3);
            }

            .stat-box {
                padding: var(--spacing-3);
            }

            .completion-icon {
                font-size: 4rem;
            }

            .completion-title {
                font-size: var(--font-size-xl);
            }

            .completion-subtitle {
                font-size: var(--font-size-base);
            }

            .empty-state {
                padding: var(--spacing-12) var(--spacing-4);
            }

            .empty-state-icon {
                font-size: 4rem;
            }

            .empty-state h2 {
                font-size: var(--font-size-xl);
            }

            .loading-spinner {
                width: 50px;
                height: 50px;
            }

            .loading-title {
                font-size: var(--font-size-lg);
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div id="header-container"></div>

    <div class="container">
        <div class="training-header">
            <h1>Тренировка</h1>
        </div>

        <!-- Прогресс -->
        <div id="progress-container" style="display: none;">
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
            </div>
            <div id="progress-text" class="progress-text">Тест 0 из 0</div>
        </div>

        <!-- Карточка тренировки -->
        <div id="training-card" class="card card-lg training-card" style="display: none;">
            <!-- Отображение слова -->
            <div class="word-display">
                <div id="word-english" class="word-en">...</div>
            </div>

            <!-- Варианты ответов -->
            <div id="options-container" class="options-container">
                <!-- Варианты добавятся через JS -->
            </div>
        </div>

        <!-- Экран завершения -->
        <div id="completion-screen" class="card card-lg training-card completion-screen" style="display: none;">
            <h2 class="completion-title">Тренировка завершена</h2>

            <div class="completion-stats">
                <div class="stats-grid">
                    <div class="stat-box">
                        <span id="correct-count" class="stat-box-value">0</span>
                        <div class="stat-box-label">Верно</div>
                    </div>
                    <div class="stat-box">
                        <span id="incorrect-count" class="stat-box-value">0</span>
                        <div class="stat-box-label">Ошибок</div>
                    </div>
                    <div class="stat-box">
                        <span id="accuracy-percent" class="stat-box-value">0%</span>
                        <div class="stat-box-label">Точность</div>
                    </div>
                </div>
            </div>

            <button id="restart-btn" class="btn btn-primary btn-lg">Начать новую тренировку</button>
        </div>

        <!-- Пустое состояние / Загрузка -->
        <div id="empty-state" class="card card-lg training-card empty-state">
            <button id="start-btn" class="btn btn-primary btn-lg">Начать тренировку</button>
        </div>
    </div>

    <script>
        // Инициализация хэдера
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof initUnifiedHeader === 'function') {
                initUnifiedHeader('header-container');
            }
        });

        // Состояние тренировки
        let currentTraining = null;
        let currentTestIndex = 0;
        let correctAnswers = 0;
        let incorrectAnswers = 0;

        // Элементы DOM
        const startBtn = document.getElementById('start-btn');
        const restartBtn = document.getElementById('restart-btn');
        const emptyState = document.getElementById('empty-state');
        const trainingCard = document.getElementById('training-card');
        const completionScreen = document.getElementById('completion-screen');
        const progressContainer = document.getElementById('progress-container');
        const progressFill = document.getElementById('progress-fill');
        const progressText = document.getElementById('progress-text');
        const wordEnglish = document.getElementById('word-english');
        const optionsContainer = document.getElementById('options-container');
        const resultFeedback = document.getElementById('result-feedback');
        const feedbackText = document.getElementById('feedback-text');
        const statRating = document.getElementById('stat-rating');
        const statStatus = document.getElementById('stat-status');

        // Проверка авторизации при загрузке
        document.addEventListener('DOMContentLoaded', async () => {
            const user = await checkAuth();
            if (!user) {
                emptyState.innerHTML = `
                    <div class="empty-state-icon">!</div>
                    <h2>Требуется авторизация</h2>
                    <p style="color: var(--color-text-muted); margin: var(--spacing-6) 0;">
                        Войдите через Telegram, чтобы начать тренировку
                    </p>
                    <a href="/" class="btn btn-primary">На главную</a>
                `;
                return;
            }
        });

        // Начать тренировку
        startBtn.addEventListener('click', startTraining);
        restartBtn.addEventListener('click', startTraining);

        async function startTraining() {
            try {
                // Показываем красивое состояние загрузки с чередующимися цитатами
                const quotes = [
                    '"The limits of my language mean the limits of my world." — Ludwig Wittgenstein',
                    '"One language sets you in a corridor for life. Two languages open every door." — Frank Smith',
                    '"Language is the road map of a culture." — Rita Mae Brown'
                ];

                emptyState.innerHTML = `
                    <div class="loading-state">
                        <div class="loading-spinner"></div>
                        <h3 class="loading-title">Generating tests...</h3>
                        <p class="loading-subtitle">AI is analyzing your vocabulary</p>
                        <div class="loading-tips">
                            ${quotes.map(quote => `<div class="loading-tip">${quote}</div>`).join('')}
                        </div>
                    </div>
                `;

                // Создаем контроллер для timeout 30 секунд
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000);

                const response = await fetch('/api/training/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Ошибка запуска тренировки');
                }

                currentTraining = data;
                currentTestIndex = 0;
                correctAnswers = 0;
                incorrectAnswers = 0;

                // Показываем интерфейс тренировки
                emptyState.style.display = 'none';
                completionScreen.style.display = 'none';
                trainingCard.style.display = 'block';
                progressContainer.style.display = 'block';

                // Показываем первый тест
                showTest();

            } catch (error) {
                emptyState.innerHTML = `
                    <div class="empty-state-icon">!</div>
                    <h2>Что-то пошло не так</h2>
                    <p class="empty-state-description">${error.message}</p>
                    <button id="retry-btn" class="btn btn-primary btn-lg">Попробовать снова</button>
                `;
                document.getElementById('retry-btn').addEventListener('click', startTraining);
            }
        }

        function showTest() {
            if (!currentTraining || currentTestIndex >= currentTraining.tests.length) {
                showCompletion();
                return;
            }

            const test = currentTraining.tests[currentTestIndex];

            // Обновляем прогресс
            const progress = ((currentTestIndex + 1) / currentTraining.tests.length) * 100;
            progressFill.style.width = `${progress}%`;
            progressText.textContent = `Тест ${currentTestIndex + 1} из ${currentTraining.tests.length}`;

            // Показываем слово
            wordEnglish.textContent = test.word;

            // Скрываем результат предыдущего теста
            resultFeedback.style.display = 'none';

            // Создаем варианты ответов
            optionsContainer.innerHTML = '';
            test.options.forEach((option, index) => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.textContent = option.text;
                btn.dataset.isCorrect = option.is_correct;
                btn.onclick = () => submitAnswer(test, option, btn);
                optionsContainer.appendChild(btn);
            });
        }

        async function submitAnswer(test, selectedOption, buttonElement) {
            // Блокируем все кнопки
            const allButtons = optionsContainer.querySelectorAll('.option-btn');
            allButtons.forEach(btn => btn.disabled = true);

            const isCorrect = selectedOption.is_correct;

            // Подсчитываем статистику
            if (isCorrect) {
                correctAnswers++;
            } else {
                incorrectAnswers++;
            }

            // Находим правильный ответ
            const correctOption = test.options.find(opt => opt.is_correct);
            const correctButton = Array.from(allButtons).find(btn => btn.dataset.isCorrect === 'true');

            // Показываем результат МГНОВЕННО
            if (isCorrect) {
                // Правильный ответ
                buttonElement.classList.add('correct');
                buttonElement.innerHTML = `
                    ${selectedOption.text}
                    <div class="answer-explanation">${test.word} = ${correctOption.text}</div>
                `;

                // Делаем остальные кнопки блеклыми
                allButtons.forEach(btn => {
                    if (btn !== buttonElement) {
                        btn.classList.add('faded');
                    }
                });
            } else {
                // Неправильный ответ
                buttonElement.classList.add('incorrect');

                if (correctButton) {
                    correctButton.classList.add('correct');
                    correctButton.innerHTML = `
                        ${correctOption.text}
                        <div class="answer-explanation">${test.word} = ${correctOption.text}</div>
                    `;
                }

                // Делаем остальные кнопки блеклыми
                allButtons.forEach(btn => {
                    if (btn !== buttonElement && btn !== correctButton) {
                        btn.classList.add('faded');
                    }
                });
            }

            // Отправляем результат на сервер (но не блокируем UI)
            fetch('/api/training/answer', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify({
                    test_id: test.test_id,
                    answer: selectedOption.text
                })
            }).then(response => {
                if (!response.ok) {
                    console.error('Ошибка сохранения ответа');
                }
            }).catch(err => console.error('Ошибка отправки ответа:', err));

            // Переходим к следующему тесту через 4 секунды
            setTimeout(() => {
                currentTestIndex++;
                showTest();
            }, 4000);
        }

        function showCompletion() {
            trainingCard.style.display = 'none';
            progressContainer.style.display = 'none';
            completionScreen.style.display = 'block';

            // Вычисляем статистику
            const total = correctAnswers + incorrectAnswers;
            const accuracy = total > 0 ? Math.round((correctAnswers / total) * 100) : 0;

            // Заполняем статистику
            document.getElementById('correct-count').textContent = correctAnswers;
            document.getElementById('incorrect-count').textContent = incorrectAnswers;
            document.getElementById('accuracy-percent').textContent = accuracy + '%';
        }
    </script>
</body>
</html>
