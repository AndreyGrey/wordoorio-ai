<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–∏ —Ö–∞–π–ª–∞–π—Ç—ã - Wordoorio</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="shortcut icon" href="/static/favicon.ico">

    <!-- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã -->
    <script src="/static/js/Auth.js"></script>
    <script src="/static/components/Header.js"></script>
    <script src="/static/components/HighlightCard.js?v=6.0"></script>
    <script src="/static/js/HighlightsStorage.js"></script>
    <script>
        // –ò–Ω—ä–µ–∫—Ü–∏—è —Å—Ç–∏–ª–µ–π HighlightCard
        document.addEventListener('DOMContentLoaded', async function() {
            const highlightStyles = document.createElement('style');
            highlightStyles.innerHTML = getHighlightCardStyles();
            document.head.appendChild(highlightStyles);

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ header
            await initUnifiedHeader('header-container');

            // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Ö–∞–π–ª–∞–π—Ç–æ–≤
            loadSavedHighlights();
        });
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@400;500;600;700&family=Manrope:wght@400;600;700;800&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(90deg, #39A0B3 0%, #1B7A94 100%);
            min-height: 100vh;
            color: #2d3748;
            padding-bottom: 60px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .page-title {
            text-align: center;
            color: #2d3748;
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 12px;
            text-shadow: 0 2px 4px rgba(255,255,255,0.3);
        }

        .page-subtitle {
            text-align: center;
            color: #4a5568;
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 40px;
        }

        .empty-state {
            background: white;
            padding: 60px 40px;
            border-radius: 16px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .empty-state h2 {
            color: #2d3748;
            font-size: 1.5rem;
            margin-bottom: 12px;
        }

        .empty-state p {
            color: #718096;
            font-size: 1rem;
            margin-bottom: 24px;
        }

        .empty-state-link {
            display: inline-block;
            background: linear-gradient(135deg, #4CAF50 0%, #45A049 100%);
            color: white;
            padding: 14px 28px;
            border-radius: 12px;
            text-decoration: none;
            font-weight: 600;
            font-size: 16px;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
            transition: all 0.2s ease;
        }

        .empty-state-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(76, 175, 80, 0.4);
        }

        /* ===== HIGHLIGHT SET ===== */
        .highlight-set {
            background: white;
            padding: 32px;
            border-radius: 16px;
            margin-bottom: 32px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }

        .set-header {
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }

        .set-title {
            color: #2d3748;
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 12px;
            line-height: 1.5;
            word-break: break-word;
        }

        .set-meta {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            align-items: center;
            color: #718096;
            font-size: 0.95rem;
        }

        .set-meta span {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .set-meta-icon {
            font-size: 1.1rem;
        }

        .set-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* ===== –°–¢–ê–¢–ò–°–¢–ò–ö–ê ===== */
        .stats-container {
            background: white;
            padding: 24px 32px;
            border-radius: 16px;
            margin-bottom: 32px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #4CAF50;
            display: block;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #718096;
            margin-top: 4px;
        }

        /* ===== –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ ===== */
        @media (max-width: 768px) {
            .container {
                padding: 20px 16px;
            }

            .page-title {
                font-size: 1.8rem;
            }

            .highlight-set {
                padding: 24px 20px;
            }

            .set-title {
                font-size: 1.1rem;
            }

            .stats-container {
                padding: 20px 16px;
            }

            .stat-value {
                font-size: 1.6rem;
            }
        }
    </style>
</head>
<body>
    <!-- Unified Header -->
    <div id="header-container"></div>

    <div class="container">
        <h1 class="page-title">üìö –ú–æ–∏ —Ö–∞–π–ª–∞–π—Ç—ã</h1>
        <p class="page-subtitle">–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Å–ª–æ–≤–∞ –∏ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è</p>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div id="stats" class="stats-container" style="display: none;">
            <div class="stat-item">
                <span class="stat-value" id="totalSets">0</span>
                <span class="stat-label">–°–µ—Ç–æ–≤</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="totalHighlights">0</span>
                <span class="stat-label">–•–∞–π–ª–∞–π—Ç–æ–≤</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="totalWords">0</span>
                <span class="stat-label">–°–ª–æ–≤</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="totalPhrases">0</span>
                <span class="stat-label">–§—Ä–∞–∑</span>
            </div>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ —Å–µ—Ç–æ–≤ -->
        <div id="setsContainer"></div>

        <!-- Empty State -->
        <div id="emptyState" class="empty-state" style="display: none;">
            <div class="empty-state-icon">üì≠</div>
            <h2>–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Ö–∞–π–ª–∞–π—Ç–æ–≤</h2>
            <p>–ê–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Ç–µ–∫—Å—Ç—ã –∏ —Å–æ—Ö—Ä–∞–Ω—è–π—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ —Å–ª–æ–≤–∞ –∏ –≤—ã—Ä–∞–∂–µ–Ω–∏—è, –Ω–∞–∂–∏–º–∞—è –∫–Ω–æ–ø–∫—É "+"</p>
            <a href="/main" class="empty-state-link">üîç –ü–µ—Ä–µ–π—Ç–∏ –∫ –∞–Ω–∞–ª–∏–∑—É</a>
        </div>
    </div>

    <script>
        async function loadSavedHighlights() {
            const storage = new HighlightsStorage();

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ª–æ–≥–∏–Ω–µ–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
            let isLoggedIn = false;
            try {
                const authResponse = await fetch('/api/auth/current');
                const authData = await authResponse.json();
                isLoggedIn = authData.success && authData.user !== null;
                console.log('üîê –°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', isLoggedIn ? '–ó–∞–ª–æ–≥–∏–Ω–µ–Ω' : '–ù–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω');
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', error);
            }

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ö–∞–π–ª–∞–π—Ç—ã —Å —Å–µ—Ä–≤–µ—Ä–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∑–∞–ª–æ–≥–∏–Ω–µ–Ω–Ω—ã—Ö)
            let serverAnalyses = [];
            if (isLoggedIn) {
                try {
                    const response = await fetch('/api/highlights');
                    const data = await response.json();
                    console.log('üì° API Response:', data);

                    if (data.success && data.analyses) {
                        serverAnalyses = data.analyses;
                        console.log('üìä –°–µ—Ä–≤–µ—Ä–Ω—ã–µ –∞–Ω–∞–ª–∏–∑—ã:', serverAnalyses.length);

                        if (serverAnalyses.length > 0) {
                            console.log('üìù –ü–µ—Ä–≤—ã–π –∞–Ω–∞–ª–∏–∑:', serverAnalyses[0]);
                        }
                    } else {
                        console.log('‚ö†Ô∏è API –Ω–µ –≤–µ—Ä–Ω—É–ª analyses –∏–ª–∏ success=false');
                    }
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ö–∞–π–ª–∞–π—Ç–æ–≤ —Å —Å–µ—Ä–≤–µ—Ä–∞:', error);
                }
            }

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            let allSessions = [];

            if (isLoggedIn) {
                // –î–ª—è –∑–∞–ª–æ–≥–∏–Ω–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π - —Ç–æ–ª—å–∫–æ —Å–µ—Ä–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                console.log('‚úÖ –ó–∞–ª–æ–≥–∏–Ω–µ–Ω - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–µ—Ä–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ');
                allSessions = serverAnalyses.map(analysis => ({
                    session_id: analysis.session_id,
                    original_text: analysis.original_text,
                    created_at: analysis.analysis_date,
                    total_highlights: analysis.total_highlights,
                    highlights: analysis.highlights.map(h => ({
                        highlight: h.highlight_word,
                        context: h.context,
                        translation: h.highlight_translation,
                        meanings: JSON.parse(h.dictionary_meanings || '[]')
                    })),
                    source: 'server'
                }));
            } else {
                // –î–ª—è –Ω–µ–∑–∞–ª–æ–≥–∏–Ω–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π - —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                console.log('üîì –ù–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ');
                const localSessions = storage.getAllSessions();
                console.log('üìä –õ–æ–∫–∞–ª—å–Ω—ã–µ —Å–µ—Å—Å–∏–∏:', localSessions.length);
                allSessions = localSessions;
            }

            console.log('üìä –í—Å–µ–≥–æ —Å–µ—Å—Å–∏–π:', allSessions.length);

            if (allSessions.length === 0) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º empty state
                document.getElementById('emptyState').style.display = 'block';
                return;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            document.getElementById('stats').style.display = 'flex';

            const setsContainer = document.getElementById('setsContainer');
            let totalHighlights = 0;
            let totalWords = 0;
            let totalPhrases = 0;

            allSessions.forEach(session => {
                // –î–ª—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Å–µ—Å—Å–∏–π –±–µ—Ä–µ–º —Ö–∞–π–ª–∞–π—Ç—ã –∏–∑ storage
                const highlights = session.source === 'server'
                    ? session.highlights
                    : storage.getSavedHighlights(session.session_id);

                if (!highlights || highlights.length === 0) {
                    return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ —Å–µ—Å—Å–∏–∏
                }

                totalHighlights += highlights.length;

                // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–ª–æ–≤–∞ –∏ —Ñ—Ä–∞–∑—ã
                highlights.forEach(h => {
                    if (h.highlight.includes(' ')) {
                        totalPhrases++;
                    } else {
                        totalWords++;
                    }
                });

                // –°–æ–∑–¥–∞–µ–º —Å–µ—Ç
                const setDiv = createHighlightSet(session, highlights, storage);
                setsContainer.appendChild(setDiv);
            });

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            document.getElementById('totalSets').textContent = allSessions.filter(s => {
                const highlights = s.source === 'server'
                    ? s.highlights
                    : storage.getSavedHighlights(s.session_id);
                return highlights && highlights.length > 0;
            }).length;
            document.getElementById('totalHighlights').textContent = totalHighlights;
            document.getElementById('totalWords').textContent = totalWords;
            document.getElementById('totalPhrases').textContent = totalPhrases;
        }

        function createHighlightSet(session, highlights, storage) {
            const setDiv = document.createElement('div');
            setDiv.className = 'highlight-set';

            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
            // –î–ª—è —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–ø—Ä–æ—â—ë–Ω–Ω—É—é –ª–æ–≥–∏–∫—É
            let setTitle;
            if (session.source === 'server') {
                // –£–ø—Ä–æ—â—ë–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –¥–ª—è —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                setTitle = session.original_text?.substring(0, 120) || '–ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–∞';
                if (session.original_text?.length > 120) setTitle += '...';
            } else {
                setTitle = storage.generateSetTitle(session.original_text, 120);
            }

            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É
            let formattedDate;
            if (session.source === 'server') {
                // –ü–∞—Ä—Å–∏–º ISO –¥–∞—Ç—É —Å —Å–µ—Ä–≤–µ—Ä–∞
                const date = new Date(session.created_at);
                formattedDate = date.toLocaleDateString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
            } else {
                formattedDate = storage.formatDate(session.created_at);
            }

            // Header —Å–µ—Ç–∞
            const headerHTML = `
                <div class="set-header">
                    <h2 class="set-title">${setTitle}</h2>
                    <div class="set-meta">
                        <span>${formattedDate}</span>
                        <span>‚Ä¢</span>
                        <span>${highlights.length} ${getWordEnding(highlights.length)}</span>
                    </div>
                </div>
            `;

            setDiv.innerHTML = headerHTML;

            // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫
            const contentDiv = document.createElement('div');
            contentDiv.className = 'set-content';

            highlights.forEach((highlight, index) => {
                // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –ë–ï–ó –∫–Ω–æ–ø–æ–∫ (showActions = false)
                const cardHTML = createHighlightCard(highlight, index, 'orange', false);

                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = cardHTML;
                contentDiv.appendChild(tempDiv.firstElementChild);
            });

            setDiv.appendChild(contentDiv);

            return setDiv;
        }

        function getWordEnding(count) {
            const lastDigit = count % 10;
            const lastTwoDigits = count % 100;

            if (lastTwoDigits >= 11 && lastTwoDigits <= 14) {
                return '—Ö–∞–π–ª–∞–π—Ç–æ–≤';
            }

            if (lastDigit === 1) {
                return '—Ö–∞–π–ª–∞–π—Ç';
            }

            if (lastDigit >= 2 && lastDigit <= 4) {
                return '—Ö–∞–π–ª–∞–π—Ç–∞';
            }

            return '—Ö–∞–π–ª–∞–π—Ç–æ–≤';
        }
    </script>
</body>
</html>