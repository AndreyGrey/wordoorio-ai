<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wordoorio EXPERIMENTAL - Двойной анализ English текстов | Тестирование новых промптов</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="shortcut icon" href="/static/favicon.ico">

    <!-- Компоненты -->
    <script src="/static/components/Header.js"></script>
    <script src="/static/components/AnalysisForm.js"></script>
    <script src="/static/components/HighlightCard.js?v=6.0"></script>
    <script src="/static/js/HighlightsStorage.js"></script>
    <script>
        // Инъекция стилей HighlightCard
        document.addEventListener('DOMContentLoaded', function() {
            const highlightStyles = document.createElement('style');
            highlightStyles.innerHTML = getHighlightCardStyles();
            document.head.appendChild(highlightStyles);

            // Инициализация унифицированного header
            initUnifiedHeader('header-container');

            // ВСЕГДА инициализируем форму (нужна для analyzeText)
            initAnalysisForm('form-container', {
                placeholder: 'Enter English text for analysis...',
                subtitle: 'Paste your English text to discover expressive vocabulary and phrases'
            });

            // После инициализации формы проверяем YouTube данные
            checkYouTubeData();
        });
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@400;500;600;700&family=Manrope:wght@400;600;700;800&display=swap');

        /* ===== ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ===== */
        :root {
            /* Цвета */
            --color-primary: #4CAF50;
            --color-text-primary: #2d3748;
            --color-text-secondary: #4a5568;
            --color-text-muted: #718096;
            --color-bg-light: #f7fafc;
            --color-bg-card: #ffffff;

            /* Типографика */
            --font-family-base: 'Inter', sans-serif;
            --font-size-sm: 0.875rem;    /* 14px */
            --font-size-base: 1rem;       /* 16px */
            --font-size-lg: 1.125rem;     /* 18px */
            --font-size-xl: 1.25rem;      /* 20px */

            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;

            /* Отступы */
            --spacing-xs: 8px;
            --spacing-sm: 12px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;

            /* Радиусы */
            --radius-sm: 6px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-pill: 999px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-family-base);
            background: linear-gradient(90deg, #39A0B3 0%, #1B7A94 100%);
            min-height: 100vh;
            color: var(--color-text-primary);
            font-size: var(--font-size-base);
            line-height: 1.6;
        }

        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
            padding: 40px 20px; 
        }
        
        
        .results {
            background: transparent;
            padding: 40px 20px;
            display: none;
        }
        
        .results-tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #f1f5f9;
        }
        
        .tab-button {
            background: transparent;
            border: none;
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease;
            margin-right: 10px;
        }
        
        .tab-button.active {
            color: #4CAF50;
            border-bottom-color: #4CAF50;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .highlight-item {
            background: #ffffff;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid #4CAF50;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.2s ease;
        }

        .highlight-item.phrase-item {
            border-left-color: #4CAF50;
        }
        
        .highlight-item:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }
        
        .highlight-word { 
            font-size: 1.25rem; 
            font-weight: 600; 
            color: #2d3748; 
            margin-bottom: 8px;
        }
        
        .highlight-translation {
            color: #4CAF50;
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 12px;
        }

        .highlight-meaning {
            color: #4a5568;
            font-size: 0.95rem;
            margin-bottom: 12px;
            padding: 12px;
            background: #f7fafc;
            border-radius: 8px;
            border-left: 3px solid #4CAF50;
        }
        
        .highlight-context { 
            color: #718096; 
            font-style: italic; 
            font-size: 0.95rem;
            line-height: 1.6;
        }
        
        .highlighted-word {
            background: linear-gradient(135deg, #4CAF50 0%, #45A049 100%);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            font-style: normal;
        }
        

        /* Стили компонента HighlightCard подключены через /static/components/HighlightCard.js */

        /* ===== УВЕДОМЛЕНИЯ ===== */
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        /* ===== БЛОК С ИСХОДНЫМ ТЕКСТОМ ===== */
        .original-text-section {
            margin-bottom: var(--spacing-xl);
        }

        .original-text {
            background: var(--color-bg-light);
            padding: var(--spacing-lg);
            border-radius: var(--radius-md);
            border-left: 4px solid var(--color-primary);
            line-height: 1.6;
            color: var(--color-text-secondary);
            font-style: italic;
            max-height: 300px;
            overflow-y: auto;
            font-size: var(--font-size-base);
        }
    </style>
</head>
<body>
    <!-- Unified Header -->
    <div id="header-container"></div>

    <div class="container">
        <!-- Универсальная форма анализа -->
        <div id="form-container"></div>

        <div id="results" class="results">
            <div id="resultsSummary"></div>

            <!-- Исходный текст -->
            <div class="original-text-section">
                <div class="original-text" id="originalText"></div>
            </div>

            <div class="results-tabs">
                <button class="tab-button active" onclick="showTab('words')">Слова</button>
                <button class="tab-button" onclick="showTab('phrases')">Фразы</button>
                <button class="tab-button" onclick="showTab('all')">Все вместе</button>
            </div>
            
            <div id="wordsTab" class="tab-content active">
                <div id="wordsList"></div>
            </div>
            
            <div id="phrasesTab" class="tab-content">
                <div id="phrasesList"></div>
            </div>
            
            <div id="allTab" class="tab-content">
                <div id="allList"></div>
            </div>
        </div>
    </div>

    <script>
        // Функции анимации теперь в LoadingAnimation.js

        function showTab(tabName) {
            // Скрываем все табы
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Убираем активность у всех кнопок
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Показываем нужный таб
            if (tabName === 'words') {
                document.getElementById('wordsTab').classList.add('active');
                event.target.classList.add('active');
            } else if (tabName === 'phrases') {
                document.getElementById('phrasesTab').classList.add('active');
                event.target.classList.add('active');
            } else if (tabName === 'all') {
                document.getElementById('allTab').classList.add('active');
                event.target.classList.add('active');
            }
        }

        async function analyzeText() {
            const textInput = document.getElementById('textInput');
            const text = textInput.value.trim();
            const button = document.querySelector('.form-button');
            const errorDiv = document.getElementById('error');
            const resultsDiv = document.getElementById('results');

            if (!text) {
                showError('Пожалуйста, введите текст для анализа');
                return;
            }

            button.disabled = true;
            button.textContent = 'ANALYZING...';
            errorDiv.style.display = 'none';
            resultsDiv.style.display = 'none';

            // Показываем анимацию загрузки с реальным текстом
            showLoadingAnimation(text);

            try {
                // Dual-prompt анализ может занять до 3 минут
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 180000); // 3 минуты
                
                const response = await fetch('/experimental/analyze', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ text: text }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                if (data.success) {
                    showResults(data);
                } else {
                    showError(data.error || 'Неизвестная ошибка');
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    showError('⏱️ Анализ занял слишком много времени. Попробуйте текст покороче или повторите позже.');
                } else if (error.message.includes('HTTP 504')) {
                    showError('⏱️ Сервер не успел обработать запрос. Попробуйте еще раз - dual-prompt анализ занимает больше времени.');
                } else {
                    showError('❌ Ошибка соединения с сервером. Попробуйте еще раз.');
                }
            } finally {
                hideLoadingAnimation();
                button.disabled = false;
                button.textContent = 'WORDOORIO!';
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        // Функция склонения слова "хайлайт"
        function pluralizeHighlights(count) {
            const lastDigit = count % 10;
            const lastTwoDigits = count % 100;

            if (lastTwoDigits >= 11 && lastTwoDigits <= 14) {
                return 'хайлайтов';
            }
            if (lastDigit === 1) {
                return 'хайлайт';
            }
            if (lastDigit >= 2 && lastDigit <= 4) {
                return 'хайлайта';
            }
            return 'хайлайтов';
        }

        function showResults(data) {
            console.log('Dual analysis results:', data);

            const resultsSummary = document.getElementById('resultsSummary');
            const highlightsWord = pluralizeHighlights(data.stats.total_highlights);

            resultsSummary.innerHTML = `
                <div style="margin-bottom:24px;">
                    <span style="display:inline-block;background-color:#0A3A4D;color:#ffffff;font-size:18px;font-weight:500;padding:8px 20px;border-radius:50px;line-height:1.1;">${data.stats.total_highlights} ${highlightsWord} из ${data.stats.total_words} слов</span>
                </div>
            `;

            // Инициализируем хранилище и создаем сессию
            const storage = new HighlightsStorage();
            const textInput = document.getElementById('textInput').value.trim();

            // Заполняем блок с исходным текстом
            const originalTextDiv = document.getElementById('originalText');
            originalTextDiv.textContent = textInput;

            // Создаем новую сессию для этого анализа
            const sessionId = storage.createSession(textInput, 'experimental');

            // Объединяем все хайлайты для сохранения в сессию
            const allHighlights = [...data.words, ...data.phrases];
            storage.saveLastAnalysis(sessionId, 'experimental', allHighlights);

            // Заполняем табы
            fillHighlightsList('wordsList', data.words, false);
            fillHighlightsList('phrasesList', data.phrases, true);
            fillHighlightsList('allList', allHighlights, false);

            // Инициализируем интеракции для кнопок
            initHighlightCardInteractions();

            document.getElementById('results').style.display = 'block';
        }

        function fillHighlightsList(listId, highlights, isPhrase) {
            const list = document.getElementById(listId);

            if (!highlights || highlights.length === 0) {
                list.innerHTML = '<p style="color:#718096;">Хайлайты не найдены</p>';
                return;
            }

            list.innerHTML = '';

            highlights.forEach((highlight, index) => {
                // Используем компонент HighlightCard v6 с кнопками (showActions=true)
                const cardHTML = createHighlightCard(highlight, index, 'orange', true);

                // Создаем div и вставляем HTML карточки
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = cardHTML;
                list.appendChild(tempDiv.firstElementChild);
            });
        }

        // Callback для сохранения карточки
        window.onHighlightSaved = function(index) {
            const storage = new HighlightsStorage();
            const analysis = storage.getLastAnalysis();

            if (!analysis) {
                console.error('No active analysis session');
                showNotification('Ошибка: нет активной сессии', 'error');
                return;
            }

            const highlight = analysis.highlights[index];

            // Проверяем не сохранена ли уже
            if (storage.isHighlightSaved(analysis.session_id, highlight)) {
                showNotification('Уже сохранено ✓');
                return;
            }

            // Сохраняем
            const success = storage.saveHighlight(analysis.session_id, highlight);
            if (success) {
                showNotification('Сохранено ✓');
            } else {
                showNotification('Ошибка сохранения', 'error');
            }
        };

        // Callback для удаления карточки
        window.onHighlightDeleted = function(index) {
            const storage = new HighlightsStorage();
            storage.markAsDeleted(index);
            console.log(`Карточка ${index} удалена из текущей сессии`);
        };

        // Функция показа уведомлений
        function showNotification(message, type = 'success') {
            // Создаем элемент уведомления
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 16px 24px;
                background: ${type === 'error' ? '#fed7d7' : '#c6f6d5'};
                color: ${type === 'error' ? '#c53030' : '#22543d'};
                border-radius: 12px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                font-weight: 600;
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;

            document.body.appendChild(notification);

            // Удаляем через 1.5 сек
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 1500);
        }

        function highlightWord(text, word) {
            if (!text || !word) return text;
            try {
                const cleanWord = word.trim().toLowerCase();
                const cleanText = text.toLowerCase();
                
                // Для фраз
                if (word.includes(' ')) {
                    let escapedWord = word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    let regex = new RegExp(escapedWord, 'gi');
                    let result = text.replace(regex, `<span class="highlighted-word">${word}</span>`);
                    if (result !== text) return result;
                    
                    // Попробуем найти каждое слово фразы отдельно
                    const words = word.split(' ');
                    for (const w of words) {
                        if (w.trim().length > 2) {
                            result = highlightWord(text, w.trim());
                            if (result !== text) return result;
                        }
                    }
                }
                
                // Для отдельных слов
                let escapedWord = cleanWord.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                let regex = new RegExp(`\\b${escapedWord}\\b`, 'gi');
                let result = text.replace(regex, `<span class="highlighted-word">${cleanWord}</span>`);
                if (result !== text) return result;
                
                // Поиск без границ слов
                regex = new RegExp(escapedWord, 'gi');
                result = text.replace(regex, `<span class="highlighted-word">${cleanWord}</span>`);
                if (result !== text) return result;
                
                return text;
            } catch(e) {
                return text;
            }
        }

        // Анализ по Ctrl+Enter
        document.getElementById('textInput').addEventListener('keypress', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                analyzeText();
            }
        });

        // === YOUTUBE AUTO-FILL ===
        function checkYouTubeData() {
            try {
                // Проверяем localStorage
                const youtubeData = localStorage.getItem('youtube_transcript_data');

                if (youtubeData) {
                    const data = JSON.parse(youtubeData);

                    // Очищаем localStorage после получения
                    localStorage.removeItem('youtube_transcript_data');

                    // СКРЫВАЕМ форму чтобы не было мигания
                    const formContainer = document.getElementById('form-container');
                    if (formContainer) {
                        formContainer.style.display = 'none';
                    }

                    // Заполняем textarea транскриптом
                    const textInput = document.getElementById('textInput');
                    if (textInput) {
                        textInput.value = data.transcript;
                    }

                    // Автоматически запускаем анализ (без задержки - сразу)
                    analyzeText();

                    return true; // Есть YouTube данные
                }
                return false; // Нет YouTube данных
            } catch (error) {
                console.log('No YouTube data in localStorage');
                return false; // Ошибка = нет данных
            }
        }
    </script>

    <!-- Компонент LoadingAnimation - загружается в конце для правильной инициализации -->
    <script src="/static/components/LoadingAnimation.js?v=1.1"></script>
</body>
</html>