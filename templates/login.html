<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í—Ö–æ–¥ | Wordoorio</title>

    <!-- CSS —Å–∏—Å—Ç–µ–º–∞ -->
    <link rel="stylesheet" href="/static/css/variables.css">
    <link rel="stylesheet" href="/static/css/global.css">
    <link rel="stylesheet" href="/static/css/components.css">

    <!-- HighlightsStorage –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏ -->
    <script src="/static/js/HighlightsStorage.js"></script>

    <style>
        body {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: var(--spacing-4);
        }

        .login-container {
            width: 100%;
            max-width: 400px;
        }

        .login-header {
            text-align: center;
            margin-bottom: var(--spacing-8);
            color: var(--color-text-white);
        }

        .login-header h1 {
            margin-bottom: var(--spacing-2);
        }

        .login-header p {
            color: var(--color-text-muted);
        }

        .login-card {
            background: var(--color-bg-white);
            padding: var(--spacing-10);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
        }

        .form-group {
            margin-bottom: var(--spacing-6);
        }

        .form-label {
            display: block;
            margin-bottom: var(--spacing-2);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            font-size: var(--font-size-sm);
        }

        .login-btn {
            margin-top: var(--spacing-4);
        }

        #error-message {
            display: none;
            margin-bottom: var(--spacing-6);
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="login-header">
            <h1>Wordoorio</h1>
            <p>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</p>
        </div>

        <div class="login-card">
            <div id="error-message" class="error-message"></div>

            <form id="login-form">
                <div class="form-group">
                    <label class="form-label" for="username">–õ–æ–≥–∏–Ω</label>
                    <input
                        type="text"
                        id="username"
                        name="username"
                        class="input"
                        required
                        autocomplete="username"
                        placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω"
                    >
                </div>

                <div class="form-group">
                    <label class="form-label" for="password">–ü–∞—Ä–æ–ª—å</label>
                    <input
                        type="password"
                        id="password"
                        name="password"
                        class="input"
                        required
                        autocomplete="current-password"
                        placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å"
                    >
                </div>

                <button type="submit" class="btn btn-primary btn-lg btn-block login-btn">
                    –í–æ–π—Ç–∏
                </button>
            </form>
        </div>
    </div>

    <script>
        const form = document.getElementById('login-form');
        const errorMessage = document.getElementById('error-message');
        const submitBtn = form.querySelector('button[type="submit"]');

        /**
         * –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å localStorage —Ö–∞–π–ª–∞–π—Ç—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä
         */
        async function migrateLocalHighlightsToServer() {
            try {
                const storage = new HighlightsStorage();
                const localSessions = storage.getAllSessions();

                if (localSessions.length === 0) {
                    console.log('‚úÖ –ù–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ö–∞–π–ª–∞–π—Ç–æ–≤ –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏');
                    return;
                }

                console.log(`üîÑ –ú–∏–≥—Ä–∞—Ü–∏—è ${localSessions.length} —Å–µ—Å—Å–∏–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä...`);

                let migratedCount = 0;
                let errorCount = 0;

                // –ú–∏–≥—Ä–∏—Ä—É–µ–º –∫–∞–∂–¥—É—é —Å–µ—Å—Å–∏—é
                for (const session of localSessions) {
                    const highlights = storage.getSavedHighlights(session.session_id);

                    if (!highlights || highlights.length === 0) {
                        continue;
                    }

                    try {
                        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä —á–µ—Ä–µ–∑ save_analysis
                        const response = await fetch('/api/migrate-highlights', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            credentials: 'same-origin',
                            body: JSON.stringify({
                                original_text: session.original_text || 'Migrated from localStorage',
                                highlights: highlights,
                                session_id: session.session_id
                            })
                        });

                        if (response.ok) {
                            migratedCount++;
                            console.log(`‚úÖ –ú–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ —Å–µ—Å—Å–∏—è ${session.session_id} (${highlights.length} —Ö–∞–π–ª–∞–π—Ç–æ–≤)`);
                        } else {
                            errorCount++;
                            console.warn(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏ —Å–µ—Å—Å–∏–∏ ${session.session_id}`);
                        }
                    } catch (err) {
                        errorCount++;
                        console.error(`‚ùå –û—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏ —Å–µ—Å—Å–∏–∏ ${session.session_id}:`, err);
                    }
                }

                console.log(`‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞: ${migratedCount} —É—Å–ø–µ—à–Ω–æ, ${errorCount} –æ—à–∏–±–æ–∫`);

                // –û—á–∏—â–∞–µ–º localStorage –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏
                if (migratedCount > 0 && errorCount === 0) {
                    localStorage.removeItem('wordoorio_sessions');
                    localStorage.removeItem('wordoorio_highlights');
                    console.log('üóëÔ∏è localStorage –æ—á–∏—â–µ–Ω');
                }
            } catch (error) {
                console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏:', error);
            }
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            // –°–∫—Ä—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
            errorMessage.style.display = 'none';

            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
            submitBtn.disabled = true;
            submitBtn.textContent = '–í—Ö–æ–¥...';

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok) {
                    // –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥ - –º–∏–≥—Ä–∏—Ä—É–µ–º localStorage ‚Üí —Å–µ—Ä–≤–µ—Ä
                    submitBtn.textContent = '–ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö...';
                    await migrateLocalHighlightsToServer();

                    // –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –≥–ª–∞–≤–Ω—É—é
                    window.location.href = '/';
                } else {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
                    errorMessage.textContent = data.error || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞';
                    errorMessage.style.display = 'block';

                    // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
                    submitBtn.disabled = false;
                    submitBtn.textContent = '–í–æ–π—Ç–∏';
                }
            } catch (error) {
                errorMessage.textContent = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º';
                errorMessage.style.display = 'block';

                submitBtn.disabled = false;
                submitBtn.textContent = '–í–æ–π—Ç–∏';
            }
        });
    </script>
</body>
</html>
